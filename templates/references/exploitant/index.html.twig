{% extends 'template_base.html.twig' %}

{% block Title %}
    SNVLT - Administrateur
{% endblock %}

{% block titre_page %}
    <h2 class="text-dark font-weight-bold mb-2">
        <img src="{{ asset('assets/images/webapp/societe.png') }}" alt="attribution">  {% trans %}Loggers{% endtrans %}
    </h2>
    <div class="d-sm-flex justify-content-xl-between align-items-center mb-2">
        <div class="btn-group p-1 rounded-5 " role="group" aria-label="Basic example">
            <a class="btn btn-primary p-2 mt-2" style="border: 0px; font-size: 16px;" href="{{ path('exploitant.edit') }}"> <i class="mdi mdi-plus-circle me-2" style="font-size: 20px;"></i>{% trans %}Add{% endtrans %}</a>
        </div>
    </div>
{% endblock %}

 {% block menu %}
     {% include 'base/menu.html.twig' %}
 {% endblock %}

{% block page_content %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.4/css/dataTables.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.1/css/buttons.dataTables.css" />
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #mapWrap {
            width: 100%;
            height: 250px;
        }
    </style>
    <section class="section sticky-top" style="border-top: solid 2px darkblue;height: 600px;overflow-y: scroll;">
        <div class="card">

            <div class="card-body">
                <table class="table" id="exploitants" style="border: 1px solid lightgrey">
                    <thead>
                    <tr class="text-dark  alert-secondary">
                        <th>Raison sociale</th>
                        <th>Sigle</th>
                        <th>Code</th>
                        <th>Marteau</th>
                        <th>Qualité</th>
                        <th>Cantonnement</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for exploitant in liste_exploitants %}

                        <tr>
                            <td class="text-dark fw-bold"><a class="getInfos" style="margin-right: 5px;font-size: 32px; color: #1f6377;" href="#" id="{{ exploitant.id }}" data-bs-target="#infos" data-bs-toggle="modal">{% if (exploitant.latitude and exploitant.longitude) %}<span class="mdi mdi-map-marker text-danger"></span>{% else %} <span class="mdi mdi-account-details"></span> {% endif %}</a><a class="badge  p-2 text-dark getInfos link-primary" style="font-size: 16px;font-weight: bold;background-color: #f9f7f7" data-bs-target="#infos" data-bs-toggle="modal" href="#" id="{{ exploitant.id }}"> {{ exploitant.raisonSocialeExploitant }}</a></td>
                            <td>{{ exploitant.sigle }}</td>
                            <td>{{ exploitant.numeroExploitant }}</td>
                            <td>{{ exploitant.marteauExploitant }}</td>

                            <td>
                                {% for qualite in exploitant.codeQualite %}
                                    <span class="badge alert-secondary text-dark p-2">
                                        {{ qualite.libelle }}
                                    </span>
                                {% endfor %}
                            </td>
                            {% if (exploitant.codeCantonnement) %}
                                <td>{{ exploitant.codeCantonnement.nomCantonnement}}</td>
                                {% else %}
                                <td>-</td>
                            {% endif %}
                            <td style="font-size: 26px;"><a href="{{ path('exploitant.edit', {'id_exploitant': exploitant.id })}}" title="Modifier"><i class="mdi mdi-database-edit text-primary"></i></a></td>
                        </tr>

                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </section>

    <div class="modal" tabindex="-1" id="infos" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Informations</h3>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <nav>
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <button class="nav-link active" id="nav-home-tab" data-toggle="tab" data-target="#nav-infos" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Informations</button>
                            <button class="nav-link" id="nav-profile-tab" data-toggle="tab" data-target="#nav-exploitation" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Exploitation</button>
                            {#<button class="nav-link" id="nav-contact-tab" data-toggle="tab" data-target="#nav-contact" type="button" role="tab" aria-controls="nav-contact" aria-selected="false">Contact</button>#}
                        </div>
                    </nav>
                    <div class="tab-content" id="nav-tabContent">
                        <div class="tab-pane fade show active" id="nav-infos" role="tabpanel" aria-labelledby="nav-home-tab">
                                <div class="p-2 div_infos bg-white" style="border: 1px solid lightgray;min-height: 300px;"></div>
                                <div class="div_map p-2"></div>
                        </div>
                        <div class="tab-pane fade show" id="nav-exploitation" role="tabpanel" aria-labelledby="nav-home-tab">
                            <div class="p-2 div_exploitation bg-white p-2" style="border: 1px solid lightgray;height: 500px;">
                                <span class="lbl_infos text-dark font-weight-bold alert-info p-2" style="font-size: large;width: 100%;"></span>
                                <div class="div_table" style="height: 450px;overflow-y: scroll;">

                                </div>
                            </div>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ asset('assets/webapp/assets/vendors/jquery/jquery.min.js') }}"></script>
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
    <script>

        let id_reprise = 0;
        let latitude = 0;
        let longitude = 0;
        let table = new DataTable('#exploitants', {
            responsive: true,
            layout: {
                topStart: {
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            title: 'Exploitants',
                            text: 'Exporter en excel',

                        }
                    ]
                }
            },
            pageLength: 10,
            colReorder: true,
            language: {
                processing:     "Traitement en cours...",
                search:         "Rechercher&nbsp;:",
                lengthMenu:    "Afficher _MENU_ &eacute;l&eacute;ments",
                info:           "Affichage de l'&eacute;lement _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",
                infoEmpty:      "Affichage de l'&eacute;lement 0 &agrave; 0 sur 0 &eacute;l&eacute;ments",
                infoFiltered:   "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
                infoPostFix:    "",
                loadingRecords: "Chargement en cours...",
                zeroRecords:    "Aucun &eacute;l&eacute;ment &agrave; afficher",
                emptyTable:     "Aucune donnée disponible dans le tableau",
                paginate: {
                    first:      "Premier",
                    previous:   "Pr&eacute;c&eacute;dent",
                    next:       "Suivant",
                    last:       "Dernier"
                },
                aria: {
                    sortAscending:  ": activer pour trier la colonne par ordre croissant",
                    sortDescending: ": activer pour trier la colonne par ordre décroissant"
                }
            }
        });

        $('body').on('click', '.getInfos', function (){
            let id_exploitant = this.id;
            getInformations(id_exploitant);
            getExploitationInfos(id_exploitant)
        })



        // Functions
        function getInformations(id_exploitant){
            let contenu = '';
            if (id_exploitant){
                document.querySelector('.div_map').innerHTML = '<h2>Chargement de la position...</h2>'
                $.ajax({
                    url : '{{ path('app_portail') }}snvlt/ref/exploitants/search/' + id_exploitant + '/data_json',
                    type: 'POST',
                    success : function (e){
                        let reponse = JSON.parse(e);
                        contenu = contenu + '<div><span class="mdi mdi-account-card-details text-dark" style="font-size: 24px;"></span><span class="ms-2 text-info font-weight-bold" style="margin-left: 5px; font-size: 24px;">' + reponse[0].rs + '</span><hr></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">Code</span><span class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: ' + reponse[0].code + '</span></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">Marteau</span><span class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: ' + reponse[0].marteau + '</span></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">Adresse</span><span class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: ' + reponse[0].adresse + '</span></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">Téléphone</span><span class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: ' + reponse[0].mobile + '</span></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">email</span><span class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: ' + reponse[0].email_info + '</span></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">Localisation</span><span class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: ' + reponse[0].localisation + '</span></div>';
                        contenu = contenu + '<div class="row"><span class="text-dark col-md-3">Lead</span><div class="ms-2 text-danger font-weight-bold col-md-8" style="margin-left: 5px;">: <span>' + reponse[0].personne_ressource + '</span></br><span style="margin-left: 5px;">' + reponse[0].email_personne_ressource + '</span> | <span style="margin-left: 5px;">  ' + reponse[0].mobile_personne_ressource + '</span></div></div>';
                        latitude = reponse[0].latitude;
                        longitude = reponse[0].longitude;
                        document.querySelector('.div_infos').innerHTML = contenu;
                        if (latitude && longitude){
                            document.querySelector('.div_map').innerHTML = '<div id="mapWrap"></div>';
                            affiche_carte(latitude, longitude);
                        } else {
                            document.querySelector('.div_map').innerHTML = '<h2 class="text-danger">Coordonnées manquantes</h2>'
                        }



                    }
                })
            }
        }

        function getExploitationInfos(id_exploitant){
            let contenu = '';
            let nb_forets  = 0;
            let nb_billes  = 0;
            let nb_arbres  = 0;
            let volume_billes  = 0;
            $('.div_table').addClass('text-center');
            document.querySelector('.div_table').innerHTML = '<img class=" mx-auto" src="{{ asset('assets/icons/spinner3.gif') }}" alt="spinner" height="300">'
            document.querySelector('.lbl_infos').innerHTML ='';
            if (id_exploitant){
                document.querySelector('.div_map').innerHTML = '<h2>Chargement de la position...</h2>'
                $.ajax({
                    url : '{{ path('app_portail') }}snvlt/ref/exploitation/search/' + id_exploitant + '/data_json',
                    type: 'POST',
                    success : function (e){
                        let reponse = JSON.parse(e);

                        contenu  = '<table class="table" id="exploitants" style="border: 1px solid lightgrey;">' +
                            '<thead>' +
                            '<tr class="text-dark  alert-light">' +
                            '<th class="text-center">Foret</th>' +
                            '<th>Décision</th>' +
                            '<th>N° Autorisation</th>' +
                            '<th class="text-center">Quota</th>' +
                            '<th class="text-center">consommation</th>' +
                            '<th class="text-center">Arbres abattus</th>' +
                            '<th class="text-center">Billes transportées</th>' +
                            '<th class="text-center">Volume billes</th>' +
                            '<th class="text-center">Nb voyages</th>' +
                            '</tr>' +
                            '</thead>' +
                            '<tbody class="body_exploitation">';


                        for (var i = 0; i < reponse.length; i++){
                            if (reponse[i].volume_billes === 0){
                                contenu = contenu + '<tr class="text-danger font-weight-bold" style="font-size: 9px;">';
                            } else {
                                contenu = contenu + '<tr style="font-size: 9px;">';
                            }

                            contenu = contenu + '<td class="text-center" style="font-size: 12px;">' + reponse[i].foret + '</td>';
                            contenu = contenu + '<td style="font-size: 12px;">' + reponse[i].decision + '</td>';
                            contenu = contenu + '<td style="font-size: 12px;">' + reponse[i].autorisation + '</td>';
                            contenu = contenu + '<td class="text-center" style="font-size: 12px;">' + reponse[i].quota + '</td>';
                            contenu = contenu + '<td class="text-center font-weight-bold" style="font-size: 12px;">' + reponse[i].pourcentage ;
                            contenu = contenu + '<div class="row"> <div class="col-md-9 progress custom-progress-success">' ;

                            if (reponse[i].pourcentage >= 0 && reponse[i].pourcentage < 50 ){
                                contenu = contenu +'<div class="progress-bar bg-primary" role="progressbar" style="width: ' + reponse[i].pourcentage  + '%" aria-valuenow="' + reponse[i].pourcentage  + '" aria-valuemin="0" aria-valuemax="100"></div></div>' +
                                    '<div class="col-md-2"><i class="mdi mdi-arrow-down text-primary font-weight-bold" style="font-size: 20px;"></i> </div></div>'
                            } else if (reponse[i].pourcentage > 49 && reponse[i].pourcentage < 80 ) {
                                contenu = contenu +'<div class="progress-bar bg-warning" role="progressbar" style="width: ' + reponse[i].pourcentage  + '%" aria-valuenow="' + reponse[i].pourcentage  + '" aria-valuemin="0" aria-valuemax="100"></div></div>' +
                                    '<div class="col-md-2"><i class="mdi mdi-arrow-down text-primary font-weight-bold" style="font-size: 20px;"></i> </div></div>'
                            } else {

                                if (reponse[i].pourcentage > 99) {
                                    contenu = contenu +'<div class="progress-bar bg-danger" role="progressbar" style="width: ' + reponse[i].pourcentage  + '%" aria-valuenow="' + reponse[i].pourcentage  + '" aria-valuemin="0" aria-valuemax="100"></div></div>' +
                                        '<div class="col-md-2"><i class="mdi mdi-arrow-up text-danger font-weight-bold" style="font-size: 32px;"></i> </div></div>'
                                } else {
                                    contenu = contenu +'<div class="progress-bar bg-danger" role="progressbar" style="width: ' + reponse[i].pourcentage  + '%" aria-valuenow="' + reponse[i].pourcentage  + '" aria-valuemin="0" aria-valuemax="100"></div></div>' +
                                        '<div class="col-md-2"><i class="mdi mdi-arrow-down text-primary font-weight-bold" style="font-size: 20px;"></i> </div></div>'
                                }
                            }

                            contenu = contenu + '</td>'
                            contenu = contenu + '<td class="text-center" style="font-size: 12px;">' + reponse[i].nb_arbres + '</td>';
                            contenu = contenu + '<td class="text-center" style="font-size: 12px;">' + reponse[i].nb_billes + '</td>';
                            contenu = contenu + '<td class="text-center" style="font-size: 12px;">' + reponse[i].volume_billes + '</td>';
                            contenu = contenu + '<td class="text-center" style="font-size: 12px;">' + reponse[i].nb_voyages + '</td>';
                            contenu = contenu + '</tr>';

                            nb_forets = nb_forets +1;
                            nb_arbres = nb_arbres + reponse[i].nb_arbres;
                            nb_billes = nb_billes + reponse[i].nb_billes;
                            volume_billes = volume_billes + reponse[i].volume_billes;
                        }
                        contenu = contenu + '</tbody></table>'

                        document.querySelector('.div_table').innerHTML = contenu;
                        document.querySelector('.lbl_infos').innerHTML = '<span style="margin-left: 5px">Forêts : ' + nb_forets.toLocaleString() + '</span><span style="margin-left: 25px">Arbres : ' + nb_arbres.toLocaleString() + '</span><span style="margin-left: 25px">Billes : ' + nb_billes.toLocaleString() + '</span><span style="margin-left: 25px;margin-right: 5px;">Volume Billes : ' + Math.round(volume_billes).toLocaleString() + 'm<sup>3</sup></span>' +
                        '<a class="btn alert-light mb-1 btn-print" id="' + id_exploitant + '" target="_blank"  style="font-size: large;margin-left: 100px;" href="{{ path('app_portail') }}snvlt/print_infos_exploitation/' + id_exploitant + '"><i class="mdi mdi-printer" style="font-size: large;"></i> Imprimer</a>';
                    }
                })
            }
        }

        function affiche_carte(latitude, longitude){
            // Define latitude, longitude and zoom level

            const zoom = 16;

            // Set DIV element to embed map
            var mymap = L.map('mapWrap');

            // Affiche la carte en Fullscreen
            mymap.addControl(new L.Control.Fullscreen());
            // google street
            googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });
            // googleStreets.addTo(map);

            //google satellite
            googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });
            var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            osm.addTo(mymap);
            var baseMaps = {
                "OSM": osm,
                'Google Street': googleStreets,
                "Google Satellite": googleSat,
            };

            L.control.layers(baseMaps).addTo(mymap);
            // Add initial marker & popup window
            var mmr = L.marker([0,0]);
            mmr.bindPopup('0,0');
            mmr.addTo(mymap);

            // Add copyright attribution


            // Set lat lng position and zoom level of map
            mmr.setLatLng(L.latLng(latitude, longitude));
            mymap.setView([latitude, longitude], zoom);

            // Set popup window content
            mmr.setPopupContent('Latitude: '+latitude+' <br /> Longitude: '+longitude).openPopup();

            // Set marker onclick event
            mmr.on('click', openPopupWindow);

            // Marker click event handler
            function openPopupWindow(e) {
                mmr.setPopupContent('Latitude: '+e.latlng.lat+' <br /> Longitude: '+e.latlng.lng).openPopup();
            }
        }
    </script>


{% endblock %}

