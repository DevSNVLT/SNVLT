{% extends 'template_base.html.twig' %}

{% block Title %}
    {% trans %}SNVLT{% endtrans %} - Cubage exploité
{% endblock %}


{% block titre_page %}
    <h2 class="text-dark font-weight-bold mb-2">
        <img src="{{ asset('assets/images/search_doc.png') }}" height="64" alt="requetes">  Cubage exploité par essence forestière
    </h2>

{% endblock %}

 {% block menu %}
     {% include 'base/menu.html.twig' %}
 {% endblock %}

{% block notifs %}
    {% include 'base/notifs.html.twig' %}
{% endblock %}

{% block page_content %}

    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.4/css/dataTables.dataTables.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.1.1/css/buttons.dataTables.css" />
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
    <link rel="stylesheet" href="{{ asset('assets/assets_other/vendor/fonts/boxicons.css') }}" />
    <link rel="stylesheet" href="{{ asset('assets/assets/css/modal.css') }}" />

    <div class="bg-white" style="min-height: 500px; border: 1px lightblue solid;">
        <div class="p-1 alert-primary text-center">
            <label class="ms-2" for="foret" style="font-size: 19px;">Essence</label>
            <select class="ms-2" name="essence" id="essence" style="height: 30px;width: 300px;background: white;font-size: 19px;border:1px lightgrey solid;margin-left: 5px;">
                {% for essence in essences %}
                    <option value="{{ essence.id }}">{{ essence.nomVernaculaire }}</option>
                {% endfor %}
            </select>
            <label for="foret ms-4 mt-2" style="font-size: 19px;margin-left: 50px;">Exercice</label>
            <select class="ms-2 text-center"  name="exercice" id="exercice" style="height: 30px;width: 100px;background: white;font-size: 18px;border:1px lightgrey solid;margin-left: 5px;">
                {% for exercice in exercices %}
                    <option value="{{ exercice.id }}">{{ exercice.annee }}</option>
                {% endfor %}
            </select>
            <a class="btn btn-primary btn-sm" style="height: 30px;font-size: 16px;margin-left:15px;" id="btn_rechercher">Rechercher</a>
            <a class="mt-1" href="#" id="all_essences" style="float: right;color:#982b03;">Charger toutes les essences forestières</a>
        </div>

        <hr>
        <div class="text-center">
            <img class="spinload my-auto" src="{{ asset('assets/icons/spinner3.gif') }}" alt="spinner" height="300" style="margin-top: -8px;">
        </div>
        <div class="container mx-auto contenu_div m-2 p-2">

        </div>
    </div>


    <script src="{{ asset('assets/webapp/assets/vendors/jquery/jquery.min.js') }}"></script>

    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.datatables.net/buttons/3.1.1/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.1.1/js/buttons.print.min.js"></script>
    <script>
        document.getElementById('exercice').value = "";
        document.getElementById('essence').value = "";
        document.getElementById('exercice').value = "";
        document.querySelector('.spinload').style = "display:none";

        $('#btn_rechercher').on('click', function (){

            let essence = document.getElementById('essence').value;
            let exercice = document.getElementById('exercice').value;
			if (essence === "" || exercice === ""){
                render_toast_value("Sélectionnez une essence et une année d'exercice avant de continuer SVP!", 0)
			} else {
				document.querySelector('.spinload').style = "display:inline;margin-top: -8px;";
                rechercher_foret(essence, exercice)
			}
        })
        $('#all_essences').on('click', function (){
            let exercice = document.getElementById('exercice').value;
			if (exercice === ""){
                render_toast_value("Sélectionnez une année d'exercice avant de continuer SVP!", 0)
			} else {
				document.querySelector('.spinload').style = "display:inline;margin-top: -8px;";
                rechercher_toutes_les_essences(exercice)
			}
        })

        function rechercher_foret(essence, exercice){
            let contenu = "";
            let denomination = "";
            let nb_billes = 0;
            let volume_total = 0;
            document.querySelector(".contenu_div").innerHTML ="<h2 class='text-danger text-center'>Cette opération peut être longue. Merci de patienter!";

            $.ajax({
                url : '{{ path('app_portail') }}snvlt/req/exploitation/cubage/essences/' + essence + '/' + exercice ,
                type : 'POST',
                success : function (response){
                    let liste_arbres = JSON.parse(response);
                    if (liste_arbres.length> 0){
                        contenu = '<div class="alert-secondary text-dark info_donnees"></div>'
                        contenu = contenu + '<table class="table border-2" style="border:solid lightgrey 1px;" id="tbl_donnees">'
                        contenu = contenu + '<thead>';
                        contenu = contenu + '<tr>';
                        contenu = contenu + '<th>Forêt</th>';
                        contenu = contenu + '<th class="text-center">Nb Billes</th>';
                        contenu = contenu + '<th class="text-center alert-warning">Volume exploité</th>';
                        contenu = contenu + '<th class="alert-light">Exploitant</th>';
                        contenu = contenu + '<th class="text-center alert-light">Année</th>';
                        contenu = contenu + '</tr>';
                        contenu = contenu + '</thead>';
                        contenu = contenu + '<tbody>';

                    for(var i=0; i< liste_arbres.length; i++){
                        contenu = contenu + '<tr>';
                        contenu = contenu + '<td class="font-weight-bold">' + liste_arbres[i].foret + '</td>';
                        contenu = contenu + '<td class="text-center">' + (liste_arbres[i].nb_billes).toLocaleString() + '</td>';
                        contenu = contenu + '<td class="text-center alert-warning">' + (liste_arbres[i].volume).toLocaleString() + '</td>';
                        contenu = contenu + '<td class="alert-light">' + liste_arbres[i].exploitant + '</td>';
                        contenu = contenu + '<td class="text-center alert-light">' + liste_arbres[i].annee + '</td>';
                        contenu = contenu + '</tr>';
                        nb_billes = nb_billes + liste_arbres[i].nb_billes ;
                        volume_total = volume_total + liste_arbres[i].volume
                    }
                    contenu = contenu + '</tbody>';
                    contenu = contenu + '</table>';
                        denomination = 'Cubage exploité - Essence ' + liste_arbres[0].essence
                        document.querySelector('.contenu_div').innerHTML = contenu;
                        document.querySelector('.info_donnees').innerHTML = '<h4 class="font-weight-light ms-2">Nombre de billes : <span class="h4 font-weight-bold">'+ nb_billes.toLocaleString() + '</span><span class="h4 font-weight-light" style="margin-left: 25px;">Volume total : <span class="font-weight-bold">'+ volume_total.toLocaleString() + '</span> m<sup>3</sup></span></h4>';

                        dataTableSnvlt("#tbl_donnees", denomination, 20)

                    } else {
                        contenu = '<h2 class="text-danger text-center">Désolé! Aucune donnée pour ces critères</h2>'
                        document.querySelector('.contenu_div').innerHTML = contenu;
                    }
                    document.querySelector('.spinload').style = "display:none;";

                }
            })
        }
        function rechercher_toutes_les_essences(exercice){
            let contenu = "";
            let denomination = "";
            let nb_billes = 0;
            let volume_total = 0;
            document.querySelector(".contenu_div").innerHTML ="<h4 class='text-center'>Chargement de toutes les essences</h4><h2 class='text-danger text-center'>Cette opération peut être longue. Merci de patienter!";

            $.ajax({
                url : '{{ path('app_portail') }}snvlt/req/exploitation/allessences/'  + exercice ,
                type : 'POST',
                success : function (response){
                    let liste_arbres = JSON.parse(response);
                    if (liste_arbres.length> 0){
                        contenu = '<div class="alert-secondary text-dark info_donnees"></div>'
                        contenu = contenu + '<table class="table border-2" style="border:solid lightgrey 1px;" id="tbl_donnees">'
                        contenu = contenu + '<thead>';
                        contenu = contenu + '<tr>';
                        contenu = contenu + '<th class="font-weight-bold">Essences</th>';
                        contenu = contenu + '<th class="text-center alert-warning">Nb Billes</th>';
                        contenu = contenu + '<th class="text-center alert-warning">Volume exploité</th>';
                        contenu = contenu + '<th class="text-center alert-light">Année</th>';
                        contenu = contenu + '</tr>';
                        contenu = contenu + '</thead>';
                        contenu = contenu + '<tbody>';

                    for(var i=0; i< liste_arbres.length; i++){
                        contenu = contenu + '<tr>';
                        contenu = contenu + '<td class="font-weight-bold">' + liste_arbres[i].essence + '</td>';
                        contenu = contenu + '<td class="text-center alert-warning">' + (liste_arbres[i].nb_billes).toLocaleString() + '</td>';
                        contenu = contenu + '<td class="text-center alert-warning">' + (liste_arbres[i].volume).toLocaleString() + '</td>';
                        contenu = contenu + '<td class="text-center alert-light">' + liste_arbres[i].annee + '</td>';
                        contenu = contenu + '</tr>';

                        nb_billes = nb_billes + liste_arbres[i].nb_billes ;
                        volume_total = volume_total + liste_arbres[i].volume
                    }
                    contenu = contenu + '</tbody>';
                    contenu = contenu + '</table>';
                     denomination = 'Cubage exploité | Toutes les Essences';



                        document.querySelector('.contenu_div').innerHTML = contenu;
                        document.querySelector('.info_donnees').innerHTML = '<h4 class="font-weight-light ms-2">Nombre de billes : <span class="h4 font-weight-bold">'+ nb_billes.toLocaleString() + '</span><span class="h4 font-weight-light" style="margin-left: 25px;">Volume total : <span class="font-weight-bold">'+ volume_total.toLocaleString() + '</span> m<sup>3</sup></span></h4>';

                        dataTableSnvlt("#tbl_donnees", denomination, 20)

                    } else {
                        contenu = '<h2 class="text-danger text-center">Désolé! Aucune donnée pour ces critères</h2>'
                        document.querySelector('.contenu_div').innerHTML = contenu;
                    }
                    document.querySelector('.spinload').style = "display:none;";

                }
            })
        }
    </script>

{% endblock %}